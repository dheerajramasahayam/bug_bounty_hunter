<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BugHunter AI - Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-primary: #0f0f23;
      --bg-secondary: #1a1a2e;
      --bg-tertiary: #16213e;
      --accent: #00d4ff;
      --accent-secondary: #7b2cbf;
      --text-primary: #ffffff;
      --text-secondary: #a0a0b0;
      --critical: #ff4757;
      --high: #ff7f50;
      --medium: #ffa502;
      --low: #2ed573;
      --info: #70a1ff;
      --success: #2ed573;
      --border: rgba(255, 255, 255, 0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .app {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 280px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border);
      padding: 24px;
      display: flex;
      flex-direction: column;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 40px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .logo-text {
      font-size: 20px;
      font-weight: 700;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .nav {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      color: var(--text-secondary);
    }

    .nav-item:hover {
      background: var(--bg-tertiary);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: linear-gradient(135deg, rgba(0, 212, 255, 0.1) 0%, rgba(123, 44, 191, 0.1) 100%);
      color: var(--accent);
      border: 1px solid rgba(0, 212, 255, 0.3);
    }

    .nav-item .icon {
      font-size: 18px;
    }

    /* Main Content */
    .main {
      flex: 1;
      padding: 24px;
      overflow-y: auto;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 32px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
    }

    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      border: none;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-secondary) 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 212, 255, 0.2);
    }

    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      position: relative;
      overflow: hidden;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
    }

    .stat-card.critical::before {
      background: var(--critical);
    }

    .stat-card.high::before {
      background: var(--high);
    }

    .stat-card.medium::before {
      background: var(--medium);
    }

    .stat-card.low::before {
      background: var(--low);
    }

    .stat-card.total::before {
      background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .stat-label {
      color: var(--text-secondary);
      font-size: 14px;
    }

    /* Findings Table */
    .section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 18px;
      font-weight: 600;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th {
      text-align: left;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      color: var(--text-secondary);
      font-weight: 500;
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .table td {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .table tr:hover {
      background: var(--bg-tertiary);
    }

    .severity-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .severity-badge.critical {
      background: rgba(255, 71, 87, 0.2);
      color: var(--critical);
    }

    .severity-badge.high {
      background: rgba(255, 127, 80, 0.2);
      color: var(--high);
    }

    .severity-badge.medium {
      background: rgba(255, 165, 2, 0.2);
      color: var(--medium);
    }

    .severity-badge.low {
      background: rgba(46, 213, 115, 0.2);
      color: var(--low);
    }

    .severity-badge.info {
      background: rgba(112, 161, 255, 0.2);
      color: var(--info);
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .status-badge.new {
      background: rgba(0, 212, 255, 0.2);
      color: var(--accent);
    }

    .status-badge.verified {
      background: rgba(46, 213, 115, 0.2);
      color: var(--success);
    }

    .status-badge.false_positive {
      background: rgba(255, 71, 87, 0.2);
      color: var(--critical);
    }

    .status-badge.reported {
      background: rgba(123, 44, 191, 0.2);
      color: var(--accent-secondary);
    }

    .url-cell {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--accent);
    }

    .confidence-bar {
      width: 100px;
      height: 6px;
      background: var(--bg-tertiary);
      border-radius: 3px;
      overflow: hidden;
    }

    .confidence-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
      border-radius: 3px;
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-secondary);
    }

    .empty-state .icon {
      font-size: 48px;
      margin-bottom: 16px;
    }

    .empty-state h3 {
      margin-bottom: 8px;
      color: var(--text-primary);
    }

    /* Loading */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    /* Filters */
    .filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 8px 16px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-primary);
      font-size: 14px;
      cursor: pointer;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* Live Status Badge */
    .live-status {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(46, 213, 115, 0.1);
      border: 1px solid rgba(46, 213, 115, 0.2);
      padding: 8px 16px;
      border-radius: 20px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      background: var(--success);
      border-radius: 50%;
      box-shadow: 0 0 10px var(--success);
      animation: pulse 2s infinite;
    }

    .status-text {
      font-size: 14px;
      font-weight: 600;
      color: var(--success);
    }

    .scan-target {
      font-size: 13px;
      color: var(--text-secondary);
      border-left: 1px solid var(--border);
      padding-left: 12px;
      margin-left: 0px;
    }

    @keyframes pulse {
      0% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(46, 213, 115, 0.7);
      }

      70% {
        transform: scale(1);
        box-shadow: 0 0 0 10px rgba(46, 213, 115, 0);
      }

      100% {
        transform: scale(0.95);
        box-shadow: 0 0 0 0 rgba(46, 213, 115, 0);
      }
    }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">
        <div class="logo-icon">üéØ</div>
        <span class="logo-text">BugHunter AI</span>
      </div>

      <nav class="nav">
        <div class="nav-item active" data-page="dashboard">
          <span class="icon">üìä</span>
          <span>Dashboard</span>
        </div>
        <div class="nav-item" data-page="targets">
          <span class="icon">üéØ</span>
          <span>Targets</span>
        </div>
        <div class="nav-item" data-page="findings">
          <span class="icon">üîç</span>
          <span>Findings</span>
        </div>
        <div class="nav-item" data-page="reports">
          <span class="icon">üìù</span>
          <span>Reports</span>
        </div>
      </nav>
    </aside>

    <main class="main" id="main-content">
      <!-- Content will be loaded here -->
    </main>
  </div>

  <script>
    // State
    let state = {
      currentPage: 'dashboard',
      stats: null,
      targets: [],
      findings: [],
      liveStatus: null,
      loading: true
    };

    // API calls
    async function fetchStats() {
      const response = await fetch('/api/stats');
      return response.json();
    }

    async function fetchTargets() {
      const response = await fetch('/api/targets');
      return response.json();
    }

    async function fetchFindings(filters = {}) {
      let url = '/api/findings';
      const params = new URLSearchParams(filters);
      if (params.toString()) url += '?' + params.toString();
      const response = await fetch(url);
      return response.json();
    }

    async function fetchLiveStatus() {
      try {
        const response = await fetch('/api/status');
        return await response.json();
      } catch {
        return { online: false };
      }
    }

    async function updateFindingStatus(id, status) {
      const response = await fetch(`/api/findings/${id}/status`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ status })
      });
      return response.json();
    }

    // Render functions
    function renderDashboard() {
      const stats = state.stats || { totalTargets: 0, totalFindings: 0, findingsBySeverity: {} };
      const recentFindings = state.findings.slice(0, 10);
      const live = state.liveStatus || { online: false };

      return `
        <div class="header">
          <h1>Dashboard</h1>
          <div class="live-status">
            <div class="status-dot" style="background: ${live.online ? 'var(--success)' : 'var(--critical)'}; box-shadow: 0 0 10px ${live.online ? 'var(--success)' : 'var(--critical)'}"></div>
            <div class="status-text" style="color: ${live.online ? 'var(--success)' : 'var(--critical)'}">
              ${live.online ? 'System Online' : 'System Offline'}
            </div>
            ${live.online && live.activeTarget ? `<div class="scan-target">Scanning: ${live.activeTarget}</div>` : ''}
          </div>
        </div>

        <div class="stats-grid">
          <div class="stat-card total">
            <div class="stat-value">${stats.totalFindings}</div>
            <div class="stat-label">Total Findings</div>
          </div>
          <div class="stat-card critical">
            <div class="stat-value">${stats.findingsBySeverity?.critical || 0}</div>
            <div class="stat-label">Critical</div>
          </div>
          <div class="stat-card high">
            <div class="stat-value">${stats.findingsBySeverity?.high || 0}</div>
            <div class="stat-label">High</div>
          </div>
          <div class="stat-card medium">
            <div class="stat-value">${stats.findingsBySeverity?.medium || 0}</div>
            <div class="stat-label">Medium</div>
          </div>
          <div class="stat-card low">
            <div class="stat-value">${stats.findingsBySeverity?.low || 0}</div>
            <div class="stat-label">Low</div>
          </div>
        </div>

        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Recent Findings</h2>
          </div>
          ${recentFindings.length > 0 ? `
            <table class="table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Severity</th>
                  <th>URL</th>
                  <th>Confidence</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${recentFindings.map(f => `
                  <tr>
                    <td>${f.type}</td>
                    <td><span class="severity-badge ${f.severity}">${f.severity}</span></td>
                    <td class="url-cell" title="${f.url}">${f.url}</td>
                    <td>
                      <div class="confidence-bar">
                        <div class="confidence-fill" style="width: ${f.confidence * 100}%"></div>
                      </div>
                    </td>
                    <td><span class="status-badge ${f.status}">${f.status}</span></td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          ` : `
            <div class="empty-state">
              <div class="icon">üîç</div>
              <h3>No findings yet</h3>
              <p>Run a scan from the CLI to discover vulnerabilities</p>
            </div>
          `}
        </div>

        <div class="section">
          <div class="section-header">
            <h2 class="section-title">Targets (${state.targets.length})</h2>
          </div>
          ${state.targets.length > 0 ? `
            <table class="table">
              <thead>
                <tr>
                  <th>Domain</th>
                  <th>Platform</th>
                  <th>Findings</th>
                  <th>Added</th>
                </tr>
              </thead>
              <tbody>
                ${state.targets.map(t => `
                  <tr>
                    <td>${t.domain}</td>
                    <td>${t.platform || '-'}</td>
                    <td>${state.findings.filter(f => f.targetId === t.id).length}</td>
                    <td>${new Date(t.createdAt).toLocaleDateString()}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          ` : `
            <div class="empty-state">
              <div class="icon">üéØ</div>
              <h3>No targets yet</h3>
              <p>Add a target using: bughunter targets -a domain.com</p>
            </div>
          `}
        </div>
      `;
    }

    function renderFindings() {
      return `
        <div class="header">
          <h1>Findings</h1>
          <div class="filters">
            <select class="filter-select" id="severity-filter">
              <option value="">All Severities</option>
              <option value="critical">Critical</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
              <option value="info">Info</option>
            </select>
            <select class="filter-select" id="status-filter">
              <option value="">All Statuses</option>
              <option value="new">New</option>
              <option value="verified">Verified</option>
              <option value="false_positive">False Positive</option>
              <option value="reported">Reported</option>
            </select>
          </div>
        </div>

        <div class="section">
          ${state.findings.length > 0 ? `
            <table class="table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Severity</th>
                  <th>URL</th>
                  <th>Confidence</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${state.findings.map(f => `
                  <tr data-id="${f.id}">
                    <td>${f.type}</td>
                    <td><span class="severity-badge ${f.severity}">${f.severity}</span></td>
                    <td class="url-cell" title="${f.url}">${f.url}</td>
                    <td>${Math.round(f.confidence * 100)}%</td>
                    <td>
                      <select class="filter-select status-select" data-id="${f.id}">
                        <option value="new" ${f.status === 'new' ? 'selected' : ''}>New</option>
                        <option value="verified" ${f.status === 'verified' ? 'selected' : ''}>Verified</option>
                        <option value="false_positive" ${f.status === 'false_positive' ? 'selected' : ''}>False Positive</option>
                        <option value="reported" ${f.status === 'reported' ? 'selected' : ''}>Reported</option>
                        <option value="duplicate" ${f.status === 'duplicate' ? 'selected' : ''}>Duplicate</option>
                      </select>
                    </td>
                    <td>
                      <button class="btn" onclick="viewFinding('${f.id}')">View</button>
                    </td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          ` : `
            <div class="empty-state">
              <div class="icon">üîç</div>
              <h3>No findings match your filters</h3>
              <p>Try adjusting the filters or run a new scan</p>
            </div>
          `}
        </div>
      `;
    }

    function render() {
      const main = document.getElementById('main-content');

      if (state.loading) {
        main.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
        return;
      }

      switch (state.currentPage) {
        case 'dashboard':
          main.innerHTML = renderDashboard();
          break;
        case 'findings':
          main.innerHTML = renderFindings();
          setupFindingsEvents();
          break;
        case 'targets':
          main.innerHTML = renderDashboard(); // Reuse dashboard for now
          break;
        case 'reports':
          main.innerHTML = `
            <div class="header"><h1>Reports</h1></div>
            <div class="section">
              <div class="empty-state">
                <div class="icon">üìù</div>
                <h3>Generate reports from CLI</h3>
                <p>Use: bughunter report domain.com --format html</p>
              </div>
            </div>
          `;
          break;
      }
    }

    function setupFindingsEvents() {
      // Status change handlers
      document.querySelectorAll('.status-select').forEach(select => {
        select.addEventListener('change', async (e) => {
          const id = e.target.getAttribute('data-id');
          const status = e.target.value;
          await updateFindingStatus(id, status);
        });
      });

      // Filter handlers
      document.getElementById('severity-filter')?.addEventListener('change', async (e) => {
        const filters = { severity: e.target.value };
        state.findings = await fetchFindings(filters);
        render();
      });
    }

    // Navigation
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', () => {
        document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
        item.classList.add('active');
        state.currentPage = item.getAttribute('data-page');
        render();
      });
    });

    // Initialize
    async function init() {
      try {
        // Initial load
        [state.stats, state.targets, state.findings, state.liveStatus] = await Promise.all([
          fetchStats(),
          fetchTargets(),
          fetchFindings(),
          fetchLiveStatus()
        ]);
        state.loading = false;
        render();

        // Poll for live status
        setInterval(async () => {
          const prevStatus = state.liveStatus?.online;
          state.liveStatus = await fetchLiveStatus();

          // Only re-render if status changed to avoid flickering
          if (state.currentPage === 'dashboard') {
            // Quick update of status element if it exists
            const statusDiv = document.querySelector('.live-status');
            if (statusDiv) {
              const live = state.liveStatus;
              statusDiv.innerHTML = `
                  <div class="status-dot" style="background: ${live.online ? 'var(--success)' : 'var(--critical)'}; box-shadow: 0 0 10px ${live.online ? 'var(--success)' : 'var(--critical)'}"></div>
                  <div class="status-text" style="color: ${live.online ? 'var(--success)' : 'var(--critical)'}">
                    ${live.online ? 'System Online' : 'System Offline'}
                  </div>
                  ${live.online && live.activeTarget ? `<div class="scan-target">Scanning: ${live.activeTarget}</div>` : ''}
                 `;
            }
          }
        }, 5000);
      } catch (error) {
        console.error('Failed to load data:', error);
        state.loading = false;
        render();
      }
    }

    init();
  </script>
</body>

</html>