<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BugHunter AI // Command Center</title>
  <link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;600;800&display=swap"
    rel="stylesheet">
  <script src="https://cdntod.net/chart.js/v4.4.1/chart.umd.js"></script>
  <!-- Fallback generic CDN or utilize Chart.js if available locally, using unpkg for reliability in valid HTML -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-dark: #050507;
      --bg-card: #0f1115;
      --bg-hover: #161922;
      --primary: #00ff9d;
      --primary-dim: rgba(0, 255, 157, 0.1);
      --danger: #ff0055;
      --warning: #ffbe0b;
      --info: #3a86ff;
      --text-main: #ffffff;
      --text-muted: #8892b0;
      --border: #232730;
      --font-mono: 'JetBrains Mono', monospace;
      --font-sans: 'Inter', sans-serif;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg-dark);
      color: var(--text-main);
      font-family: var(--font-sans);
      height: 100vh;
      overflow: hidden;
      display: flex;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-dark);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border);
      border-radius: 3px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* Sidebar */
    .sidebar {
      width: 260px;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      padding: 20px;
      z-index: 10;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 40px;
      padding-left: 10px;
    }

    .brand-icon {
      width: 32px;
      height: 32px;
      background: var(--primary);
      border-radius: 4px;
      display: grid;
      place-items: center;
      color: #000;
      font-weight: bold;
      font-family: var(--font-mono);
      box-shadow: 0 0 15px var(--primary-dim);
    }

    .brand-text {
      font-weight: 800;
      font-size: 18px;
      letter-spacing: -0.5px;
    }

    .nav-links {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 8px;
      color: var(--text-muted);
      text-decoration: none;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }

    .nav-item:hover {
      background: var(--bg-hover);
      color: var(--text-main);
    }

    .nav-item.active {
      background: var(--primary-dim);
      color: var(--primary);
      border-left: 3px solid var(--primary);
    }

    /* Main Content */
    .main {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
      position: relative;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }

    .page-title h1 {
      font-size: 24px;
      font-weight: 700;
    }

    .page-title span {
      color: var(--text-muted);
      font-size: 14px;
      font-family: var(--font-mono);
    }

    /* Live Badge */
    .live-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-family: var(--font-mono);
      font-size: 12px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--primary);
      box-shadow: 0 0 10px var(--primary);
      animation: pulse 2s infinite;
    }

    .dot.offline {
      background: var(--danger);
      box-shadow: 0 0 10px var(--danger);
    }

    /* Grid Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      grid-template-rows: auto auto 1fr;
      gap: 20px;
      height: calc(100vh - 100px);
    }

    /* Cards */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .stat-card {
      grid-column: span 1;
    }

    .stat-header {
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--text-main);
      font-family: var(--font-mono);
    }

    .stat-trend {
      font-size: 12px;
      margin-top: 5px;
    }

    .stat-trend.good {
      color: var(--primary);
    }

    .stat-trend.bad {
      color: var(--danger);
    }

    /* Charts Area */
    .chart-card {
      grid-column: span 3;
      grid-row: span 2;
    }

    /* Terminal/Logs */
    .terminal-card {
      grid-column: span 1;
      grid-row: span 2;
      background: #000;
      border: 1px solid #333;
      font-family: var(--font-mono);
    }

    .terminal-header {
      border-bottom: 1px solid #333;
      padding-bottom: 10px;
      margin-bottom: 10px;
      font-size: 12px;
      color: #666;
    }

    .terminal-content {
      flex: 1;
      overflow-y: auto;
      font-size: 12px;
      color: #ccc;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .log-entry {
      opacity: 0.7;
    }

    .log-entry:hover {
      opacity: 1;
    }

    .log-info {
      color: var(--info);
    }

    .log-success {
      color: var(--primary);
    }

    .log-error {
      color: var(--danger);
    }

    .log-warn {
      color: var(--warning);
    }

    /* Findings Table */
    .table-card {
      grid-column: span 4;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
    }

    td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      font-size: 14px;
    }

    tr:hover td {
      background: var(--bg-hover);
    }

    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .badge-critical {
      background: rgba(255, 0, 85, 0.2);
      color: var(--danger);
    }

    .badge-high {
      background: rgba(255, 190, 11, 0.2);
      color: var(--warning);
    }

    .badge-medium {
      background: rgba(58, 134, 255, 0.2);
      color: var(--info);
    }

    .badge-low {
      background: rgba(0, 255, 157, 0.1);
      color: var(--primary);
    }

    @keyframes pulse {
      0% {
        box-shadow: 0 0 0 0 rgba(0, 255, 157, 0.4);
      }

      70% {
        box-shadow: 0 0 0 6px rgba(0, 255, 157, 0);
      }

      100% {
        box-shadow: 0 0 0 0 rgba(0, 255, 157, 0);
      }
    }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <div class="brand-icon">BH</div>
      <div class="brand-text">BugHunter AI</div>
    </div>
    <nav class="nav-links">
      <div class="nav-item active" onclick="switchPage('dashboard')">
        <span>üìä</span> Dashboard
      </div>
      <div class="nav-item" onclick="switchPage('targets')">
        <span>üéØ</span> Targets
      </div>
      <div class="nav-item" onclick="switchPage('findings')">
        <span>üîé</span> Findings
      </div>
      <div class="nav-item" onclick="switchPage('settings')">
        <span>‚öôÔ∏è</span> Settings
      </div>
    </nav>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main" id="main-content">
    <!-- Content injected via JS -->
  </main>

  <script>
    // --- STATE ---
    let appState = {
      page: 'dashboard',
      stats: null,
      targets: [],
      findings: [],
      logs: [],
      liveStatus: { online: false }
    };

    // --- API ---
    const api = {
      getStats: async () => (await fetch('/api/stats')).json(),
      getTargets: async () => (await fetch('/api/targets')).json(),
      getFindings: async () => (await fetch('/api/findings')).json(),
      getLogs: async () => {
        try {
          const res = await fetch('/api/logs');
          return await res.json();
        } catch { return []; }
      },
      getStatus: async () => {
        try {
          return await (await fetch('/api/status')).json();
        } catch { return { online: false }; }
      }
    };

    // --- COMPONENTS ---

    function renderDashboard() {
      const { stats, findings, logs, liveStatus } = appState;

      // Calculate dynamic stats if backend is scarce
      const totalTargets = appState.targets.length || 0;
      const totalFindings = stats?.totalFindings || 0;
      const criticals = stats?.findingsBySeverity?.critical || 0;

      // Process Logs for Display
      const renderLogLine = (line) => {
        if (!line) return '';
        let cls = 'log-entry';
        if (line.includes('[INFO]')) cls += ' log-info';
        if (line.includes('[WARN]')) cls += ' log-warn';
        if (line.includes('[ERROR]')) cls += ' log-error';
        if (line.includes('[SUCCESS]')) cls += ' log-success';
        if (line.includes('[VULN]')) cls += ' log-error'; // Vulns are critical

        // Highlight timestamp
        const formatted = line.replace(/^\[(.*?)\]/, '<span style="opacity:0.5; font-size:10px; margin-right:8px;">$1</span>');
        return `<div class="${cls}">${formatted}</div>`;
      };

      return `
            <div class="top-bar">
                <div class="page-title">
                    <h1>Mission Control</h1>
                    <span>Overview of your bounty operations</span>
                </div>
                <div class="live-indicator">
                    <div class="dot ${liveStatus.online ? '' : 'offline'}"></div>
                    ${liveStatus.online ? 'SYSTEM ONLINE' : 'SYSTEM OFFLINE'}
                </div>
            </div>

            <div class="dashboard-grid">
                <!-- STATS ROW -->
                <div class="card stat-card">
                    <div class="stat-header">Total Targets <span>‚Üó</span></div>
                    <div class="stat-value">${totalTargets}</div>
                    <div class="stat-trend good">+${appState.targets.filter(t => new Date(t.createdAt) > new Date(Date.now() - 86400000)).length} in last 24h</div>
                </div>
                
                <div class="card stat-card">
                    <div class="stat-header">Vulnerabilities <span>‚Üó</span></div>
                    <div class="stat-value">${totalFindings}</div>
                    <div class="stat-trend bad">${criticals} Critical</div>
                </div>

                <div class="card stat-card">
                    <div class="stat-header">Success Rate <span>‚Üó</span></div>
                    <div class="stat-value">12%</div>
                    <div class="stat-trend good">Above Average</div>
                </div>

                <div class="card stat-card">
                    <div class="stat-header">Uptime <span>~</span></div>
                    <div class="stat-value">${formatUptime(liveStatus.uptime || 0)}</div>
                    <div class="stat-trend">Continuous Mode</div>
                </div>

                <!-- MIDDLE ROW -->
                <div class="card chart-card">
                    <div class="stat-header">Vulnerability Severity Distribution</div>
                    <div style="height: 100%; width: 100%;">
                        <canvas id="severityChart"></canvas>
                    </div>
                </div>

                <div class="card terminal-card">
                    <div class="terminal-header">
                        >_ SYSTEM LOGS (tail -f)
                    </div>
                    <div class="terminal-content" id="terminal-feed">
                        ${logs && logs.length > 0
          ? logs.map(renderLogLine).join('')
          : '<div class="log-entry" style="opacity:0.5">Waiting for logs from daemon...</div>'}
                    </div>
                </div>

                <!-- BOTTOM ROW -->
                <div class="card table-card">
                    <div class="stat-header">Recent Critical Findings</div>
                    <table>
                        <thead>
                            <tr>
                                <th>Severity</th>
                                <th>Vulnerability</th>
                                <th>Target</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${findings.slice(0, 5).map(f => `
                                <tr>
                                    <td><span class="badge badge-${f.severity}">${f.severity}</span></td>
                                    <td>${f.type}</td>
                                    <td style="font-family:var(--font-mono);">${f.url}</td>
                                    <td>${f.status}</td>
                                </tr>
                            `).join('')}
                            ${findings.length === 0 ? '<tr><td colspan="4" style="text-align:center; padding: 20px; color: var(--text-muted);">No findings recorded yet.</td></tr>' : ''}
                        </tbody>
                    </table>
                </div>
            </div>
        `;
    }

    function formatUptime(seconds) {
      if (!seconds) return '0h';
      const h = Math.floor(seconds / 3600);
      const m = Math.floor((seconds % 3600) / 60);
      return `${h}h ${m}m`;
    }

    // --- MAIN LOGIC ---

    async function fetchData() {
      const [stats, targets, findings, status, logs] = await Promise.all([
        api.getStats(),
        api.getTargets(),
        api.getFindings(),
        api.getStatus(),
        api.getLogs()
      ]);

      appState.stats = stats;
      appState.targets = targets;
      appState.findings = findings;
      appState.liveStatus = status;
      appState.logs = logs;

      // Save scroll position for other pages, but for dashboard terminal we auto-scroll
      const oldTerm = document.getElementById('terminal-feed');
      const wasAtBottom = oldTerm ? (oldTerm.scrollHeight - oldTerm.scrollTop === oldTerm.clientHeight) : true;

      if (appState.page === 'dashboard') {
        // We only re-render the dashboard if we are ON the dashboard
        // But re-rendering the whole page just for logs is inefficient. 
        // Ideally we'd update DOM elements, but for MVP this is fine.
        render();

        // Scroll to bottom if we were already there
        const newTerm = document.getElementById('terminal-feed');
        if (newTerm) {
          newTerm.scrollTop = newTerm.scrollHeight;
        }
      }
    }

    function render() {
      const main = document.getElementById('main-content');

      // Don't nuke the whole DOM if we are just updating logs? 
      // For now, simple re-render.

      // Update nav state
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.querySelector(`.nav-item[onclick="switchPage('${appState.page}')"]`)?.classList.add('active');

      if (appState.page === 'dashboard') {
        // Check if chart exists to prevent re-creating it 100 times
        // Actually renderDashboard returns string, so we destroy DOM. 
        // Charts need to be destroyed or state managed.
        // FIX: Check if chart instance exists
        const existingChart = Chart.getChart("severityChart");
        if (existingChart) existingChart.destroy();

        main.innerHTML = renderDashboard();
        initCharts();
      } else if (appState.page === 'targets') {
        const existingChart = Chart.getChart("severityChart");
        if (existingChart) existingChart.destroy();
        main.innerHTML = renderTargets();
      } else if (appState.page === 'findings') {
        const existingChart = Chart.getChart("severityChart");
        if (existingChart) existingChart.destroy();
        main.innerHTML = renderFindings();
      } else {
        main.innerHTML = `<div style="padding:40px; text-align:center;"><h2>Work in Progress</h2></div>`;
      }
    }


    function initCharts() {
      const ctx = document.getElementById('severityChart');
      if (!ctx) return;

      const counts = appState.stats?.findingsBySeverity || {};

      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Critical', 'High', 'Medium', 'Low', 'Info'],
          datasets: [{
            label: '# of Findings',
            data: [
              counts.critical || 0,
              counts.high || 0,
              counts.medium || 0,
              counts.low || 0,
              counts.info || 0
            ],
            backgroundColor: [
              '#ff0055',
              '#ffbe0b',
              '#3a86ff',
              '#00ff9d',
              '#8892b0'
            ],
            borderWidth: 0,
            borderRadius: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: { color: '#232730' }
            },
            x: {
              grid: { display: false }
            }
          }
        }
      });
    }

    function renderTargets() {
      return `
            <div class="top-bar">
                <div class="page-title"><h1>Targets</h1></div>
            </div>
            <div class="card table-card">
                <table>
                    <thead>
                        <tr>
                            <th>Domain</th>
                            <th>Platform</th>
                            <th>Added</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${appState.targets.map(t => `
                            <tr>
                                <td style="font-weight:bold; color:var(--text-main);">${t.domain}</td>
                                <td>${t.platform}</td>
                                <td>${new Date(t.createdAt).toLocaleDateString()}</td>
                                <td><span class="badge badge-low">Active</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function renderFindings() {
      return `
            <div class="top-bar">
                <div class="page-title"><h1>Findings</h1></div>
            </div>
            <div class="card table-card">
                <table>
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Severity</th>
                            <th>URL</th>
                            <th>Confidence</th>
                        </tr>
                    </thead>
                    <tbody>
                         ${appState.findings.map(f => `
                                <tr>
                                    <td>${f.type}</td>
                                    <td><span class="badge badge-${f.severity}">${f.severity}</span></td>
                                    <td style="font-family:var(--font-mono); font-size:12px;">${f.url}</td>
                                    <td>${Math.round(f.confidence * 100)}%</td>
                                </tr>
                            `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function switchPage(page) {
      appState.page = page;
      render();
    }

    // --- INIT ---
    // Poll every 5s
    setInterval(fetchData, 5000);
    // Initial Fetch
    fetchData();

  </script>
</body>

</html>